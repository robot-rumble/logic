version: "v1.0"
name: Logic

agent:
  machine:
    type: e1-standard-2
  containers:
    - name: main
      image: 'registry.semaphoreci.com/rust:1.75-bookworm'

global_job_config:
  env_vars:
    - name: S3_BUCKET_BUILD
      value: rr-build-files
    - name: S3_BUCKET_PUBLIC
      value: rr-public-assets
  secrets:
    - name: aws
  prologue:
    commands:
      - checkout
      - sudo apt update && sudo apt install -y awscli

blocks:
  - name: wasm-layer
    dependencies: [lang-runners]
    run:
      when: "change_in(['/lang-runners/', '/env-runners/lambda-cache/'])"
    task:
      jobs:
        - name: Build and Upload to S3
          commands:
            - aws s3 sync s3://${S3_BUCKET_PUBLIC}/lang-runners wasm-dist/lang-runners
            # install llvm
            - sudo deb http://apt.llvm.org/bookworm/ llvm-toolchain-bookworm main
            - sudo deb-src http://apt.llvm.org/bookworm/ llvm-toolchain-bookworm main
            - S3_BUCKET=${S3_BUCKET_BUILD} FUNCTION_NAME=battle-runner bash build-lambda.sh --deploy --prod --wasm-layer

